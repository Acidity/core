## encoding: utf-8

<%!
from brave.core.group.acl import ACLList, ACLKey, ACLTitle, ACLRole, ACLMask
%>

<%inherit file="brave.core.template.master"/>

<%block name="title">${group.id | h} - ${group.title | h}</%block>

<%block name="pre">
    ${parent.pre()}

    <style type="text/css">
        .stringlistinput .remove {
            cursor: pointer;
        }

        .handle {
            cursor: move;
        }

        #acl-rules select {
            padding: 0;
            width: auto;
        }
        .stringlistinput li:not(:last-child) {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 0 3px;
            margin: 3px;
        }
        .stringlistinput li .input-append {
            margin-bottom: 0;
        }
        .stringlistinput li .add-on {
            height: auto;
        }
    </style>
</%block>

<%block name="post">
    ${parent.post()}

    <script type="text/javascript" charset="utf-8">
        $(function() {
            $(".sortable").sortable({handle: ".handle"});

            function get_rule_data() {
                var a = [];
                $("#acl-rules > li").each(function() {
                    a.push($(this).find(":input").serializeAssoc());
                });
                return a;
            }

            $("#submit").click(function() {
                console.log(JSON.stringify(get_rule_data()));
                $.post($("#acl-rules").data("action"), {
                    rules: JSON.stringify(get_rule_data()),
                }, function(data) {
                    var confirm_text = "Here's what the server heard. Check to make sure everything looks right!<pre>" + data + "</pre>";
                    confirm("confirm", confirm_text, "okay", function() {
                        $.post($("#acl-rules").data("action"), {
                            rules: JSON.stringify(get_rule_data()),
                            really: "really",
                        }, function(data) {
                            alert("ok");
                        });
                    });
                });
            });

            $(".addrule").click(function() {
                var template_selector = ".acl"+$(this).data("rule");
                var kind = $(this).data("kind");
                if (kind) {
                    template_selector += "[data-kind="+kind+"]";
                }
                var editor = $("#acl-templates").find(template_selector).clone();
                var row = $("#row-template-container li").clone();
                row.find(".rule").append(editor);
                $("#acl-rules").append(row);
            });

            $("body").on("click", ".stringlistinput .remove", function() {
                $(this).closest("li").remove();
            });

            $("body").on("click", ".acllist .stringlistinput .add", function() {
                var $ul = $(this).closest('ul');
                var $text_input = $(this).siblings("input[type=text]");

                var new_string = $text_input.val();
                var validate_input = $(this).closest('.stringlistinput').data('validate-input');
                if (validate_input) {
                    if (!validate_input(new_string)) {
                        return;
                    }
                }

                var input_name = $(this).closest('.stringlistinput').data('input-name');
                var $li = $('<li>').text(new_string + " ")
                               .append($('<input type="hidden">').attr('name', input_name).val(new_string))
                               .append($('<i class="remove fa fa-times">'))
                               .insertBefore($ul.children().last());
                $text_input.val("");
            });

            $(".acllist .stringlistinput").data('validate-input', function(input) {
                console.log("fixme");
                return true;
            });
        });
    </script>
</%block>

<%def name="stringlistinput(input_name, list)">
<div class="stringlistinput" data-input-name="${input_name}">
    <ul class="inline">
        % for item in list:
            <li>
                ${item | h}
                <input type="hidden" name="${input_name}" value="${item | h}" />
                <i class="remove fa fa-times"></i>
            </li>
        % endfor
        <li>
            <div class="input-append">
                <input type="text"/>
                <button class="add add-on">add</button>
            </div>
        </li>
    </ul>
</div>
</%def>

<%def name="aclrule(rule)">
    % if isinstance(rule, ACLList):
        ${acllist(rule)}
    % elif isinstance(rule, ACLKey):
        ${aclkey(rule)}
    % elif isinstance(rule, ACLTitle):
        ${acltitle(rule)}
    % elif isinstance(rule, ACLRole):
        ${aclrole(rule)}
    % elif isinstance(rule, ACLMask):
        ${aclmask(rule)}
    % else:
        ERROR THIS WON'T WORK: ${rule.human_readable_repr()}
    % endif
</%def>

<%def name="acllist(rule)">
    <div class="acllist" data-kind="${rule.kind}">
        <input type="hidden" name="type" value="list" />
        <input type="hidden" name="kind" value="${rule.kind}" />
        <select name="grant">
            <option value="true">grant</option>
            <option value="false">deny</option>
        </select>
        if character
        <select name="inverse">
            <option value="false">is</option>
            <option value="true">is not</option>
        </select>
        % if rule.kind == "c":
            one of these characters:
        % elif rule.kind == "o":
            in one of these corporations:
        % else:
            in one of these alliances:
        % endif
        ${stringlistinput("names", [o.name for o in rule.target_objects()])}
    </div>
</%def>

<%def name="aclkey(rule)">
    <div class="aclkey">
        <input type="hidden" name="type" value="key" />
        <select name="grant">
            <option value="true">grant</option>
            <option value="false">deny</option>
        </select>
        if key type
        <select name="inverse">
            <option value="false">is</option>
            <option value="true">is not</option>
        </select>
        <select name="kind">
            <option value="Account">Account</option>
            <option value="Character">Character</option>
            <option value="Corporation">Corporation</option>
        </select>
    </div>
</%def>

<%def name="acltitle(rule)">
    <div class="acltitle">
        <input type="hidden" name="type" value="title" />
        <select name="grant">
            <option value="true">grant</option>
            <option value="false">deny</option>
        </select>
        if character
        <select name="inverse">
            <option value="false">has any</option>
            <option value="true">has none</option>
        </select>
        of these titles:
        ${stringlistinput("titles", rule.titles)}
    </div>
</%def>

<%def name="aclrole(rule)">
    <div class="aclrole">
        <input type="hidden" name="type" value="role" />
        <select name="grant">
            <option value="true">grant</option>
            <option value="false">deny</option>
        </select>
        if character
        <select name="inverse">
            <option value="false">has any</option>
            <option value="true">has none</option>
        </select>
        of these roles:
        ${stringlistinput("roles", rule.roles)}
    </div>
</%def>

<%def name="aclmask(rule)">
    <div class="aclmask">
        <input type="hidden" name="type" value="mask" />
        <select name="grant">
            <option value="true">grant</option>
            <option value="false">deny</option>
        </select>
        if the character's user
        <select name="inverse">
            <option value="false">has</option>
            <option value="true">has not</option>
        </select>
        submitted a key supporting permissions:
        <input type="text" name="mask" value="${rule.mask}" />
        (todo readability)
    </div>
</%def>

<div class="container-fluid">

    <div id="pad-wrapper">
        <div class="row-fluid header">
            <h3>${group.id | h} - ${group.title | h}</h3>
        </div>
        <div class="row-fluid table">
            % if not len(group.rules):
                <p class="subtext" style="text-transform: uppercase;"><strong>This group has no ACL rules.</strong></p>
            % else:
                Rules:
                <ul id="acl-rules" class="sortable" data-action="/group/${group.id}/set_rules">
                    % for rule in group.rules:
                        <li><span class="handle">[drag]</span> ${aclrule(rule)}</li>
                    % endfor
                </ul>
            % endif
        </div>
        <div>
            Add new rule:
            <button class="addrule" data-rule="list" data-kind="c">by character</button>
            <button class="addrule" data-rule="list" data-kind="o">by corporation</button>
            <button class="addrule" data-rule="list" data-kind="a">by alliance</button>
            <button class="addrule" data-rule="key">by key type</button>
            <button class="addrule" data-rule="title">by corporate title</button>
            <button class="addrule" data-rule="role">by corporate role</button>
            <button class="addrule" data-rule="mask">by key mask</button>
        </div>
        <button id="submit">submit</button>
    </div>
</div>

<ul style="display: none" id="row-template-container">
    <li>
        <span class="handle">[drag]</span> <span class="rule"></span>
    </li>
</ul>
<div style="display: none" id="acl-templates">
    ${aclrule(ACLList(kind='c', ids=[]))}
    ${aclrule(ACLList(kind='o', ids=[]))}
    ${aclrule(ACLList(kind='a', ids=[]))}
    ${aclrule(ACLKey(kind='Account'))}
    ${aclrule(ACLTitle(titles=[]))}
    ${aclrule(ACLRole(roles=[]))}
    ${aclrule(ACLMask(mask=0))}
</div>
